group = "Color Map"
display_name = "Black-Body Radiation (expensive)"
inputs = {
	"8deba514-fbf0-4f71-808a-5654f82238b0" = { name = "T" display_name = "T" type = "scalar" is_required = true }
	"149ae0c3-db91-4009-9aed-45281b8e3d4c" = { name = "blend" display_name = "Blend" type = { scalar: ["HAS_BLEND_FACTOR"] } is_required = false }
}

output = {
	type = "float3"
}

code = """
	float3 table[89] = {
		float3(3.769647E-03,	4.146161E-04,	1.847260E-02),
		float3(9.382967E-03,	1.059646E-03,	4.609784E-02),
		float3(2.214302E-02,	2.452194E-03,	1.096090E-01),
		float3(4.742986E-02,	4.971717E-03,	2.369246E-01),
		float3(8.953803E-02,	9.079860E-03,	4.508369E-01),
		float3(1.446214E-01,	1.429377E-02,	7.378822E-01),
		float3(2.035729E-01,	2.027369E-02,	1.051821E+00),
		float3(2.488523E-01,	2.612106E-02,	1.305008E+00),
		float3(2.918246E-01,	3.319038E-02,	1.552826E+00),
		float3(3.227087E-01,	4.157940E-02,	1.748280E+00),
		float3(3.482554E-01,	5.033657E-02,	1.917479E+00),
		float3(3.418483E-01,	5.743393E-02,	1.918437E+00),
		float3(3.224637E-01,	6.472352E-02,	1.848545E+00),
		float3(2.826646E-01,	7.238339E-02,	1.664439E+00),
		float3(2.485254E-01,	8.514816E-02,	1.522157E+00),
		float3(2.219781E-01,	1.060145E-01,	1.428440E+00),
		float3(1.806905E-01,	1.298957E-01,	1.250610E+00),
		float3(1.291920E-01,	1.535066E-01,	9.991789E-01),
		float3(8.182895E-02,	1.788048E-01,	7.552379E-01),
		float3(4.600865E-02,	2.064828E-01,	5.617313E-01),
		float3(2.083981E-02,	2.379160E-01,	4.099313E-01),
		float3(7.097731E-03,	2.850680E-01,	3.105939E-01),
		float3(2.461588E-03,	3.483536E-01,	2.376753E-01),
		float3(3.649178E-03,	4.277595E-01,	1.720018E-01),
		float3(1.556989E-02,	5.204972E-01,	1.176796E-01),
		float3(4.315171E-02,	6.206256E-01,	8.283548E-02),
		float3(7.962917E-02,	7.180890E-01,	5.650407E-02),
		float3(1.268468E-01,	7.946448E-01,	3.751912E-02),
		float3(1.818026E-01,	8.575799E-01,	2.438164E-02),
		float3(2.405015E-01,	9.071347E-01,	1.566174E-02),
		float3(3.098117E-01,	9.544675E-01,	9.846470E-03),
		float3(3.804244E-01,	9.814106E-01,	6.131421E-03),
		float3(4.494206E-01,	9.890228E-01,	3.790291E-03),
		float3(5.280233E-01,	9.994608E-01,	2.327186E-03),
		float3(6.133784E-01,	9.967737E-01,	1.432128E-03),
		float3(7.016774E-01,	9.902549E-01,	8.822531E-04),
		float3(7.967750E-01,	9.732611E-01,	5.452416E-04),
		float3(8.853376E-01,	9.424569E-01,	3.386739E-04),
		float3(9.638388E-01,	8.963613E-01,	2.117772E-04),
		float3(1.051011E+00,	8.587203E-01,	1.335031E-04),
		float3(1.109767E+00,	8.115868E-01,	8.494468E-05),
		float3(1.143620E+00,	7.544785E-01,	5.460706E-05),
		float3(1.151033E+00,	6.918553E-01,	3.549661E-05),
		float3(1.134757E+00,	6.270066E-01,	2.334738E-05),
		float3(1.083928E+00,	5.583746E-01,	1.554631E-05),
		float3(1.007344E+00,	4.895950E-01,	1.048387E-05),
		float3(9.142877E-01,	4.229897E-01,	0.000000E+00),
		float3(8.135565E-01,	3.609245E-01,	0.000000E+00),
		float3(6.924717E-01,	2.980865E-01,	0.000000E+00),
		float3(5.755410E-01,	2.416902E-01,	0.000000E+00),
		float3(4.731224E-01,	1.943124E-01,	0.000000E+00),
		float3(3.844986E-01,	1.547397E-01,	0.000000E+00),
		float3(2.997374E-01,	1.193120E-01,	0.000000E+00),
		float3(2.277792E-01,	8.979594E-02,	0.000000E+00),
		float3(1.707914E-01,	6.671045E-02,	0.000000E+00),
		float3(1.263808E-01,	4.899699E-02,	0.000000E+00),
		float3(9.224597E-02,	3.559982E-02,	0.000000E+00),
		float3(6.639960E-02,	2.554223E-02,	0.000000E+00),
		float3(4.710606E-02,	1.807939E-02,	0.000000E+00),
		float3(3.292138E-02,	1.261573E-02,	0.000000E+00),
		float3(2.262306E-02,	8.661284E-03,	0.000000E+00),
		float3(1.575417E-02,	6.027677E-03,	0.000000E+00),
		float3(1.096778E-02,	4.195941E-03,	0.000000E+00),
		float3(7.608750E-03,	2.910864E-03,	0.000000E+00),
		float3(5.214608E-03,	1.995557E-03,	0.000000E+00),
		float3(3.569452E-03,	1.367022E-03,	0.000000E+00),
		float3(2.464821E-03,	9.447269E-04,	0.000000E+00),
		float3(1.703876E-03,	6.537050E-04,	0.000000E+00),
		float3(1.186238E-03,	4.555970E-04,	0.000000E+00),
		float3(8.269535E-04,	3.179738E-04,	0.000000E+00),
		float3(5.758303E-04,	2.217445E-04,	0.000000E+00),
		float3(4.058303E-04,	1.565566E-04,	0.000000E+00),
		float3(2.856577E-04,	1.103928E-04,	0.000000E+00),
		float3(2.021853E-04,	7.827442E-05,	0.000000E+00),
		float3(1.438270E-04,	5.578862E-05,	0.000000E+00),
		float3(1.024685E-04,	3.981884E-05,	0.000000E+00),
		float3(7.347551E-05,	2.860175E-05,	0.000000E+00),
		float3(5.259870E-05,	2.051259E-05,	0.000000E+00),
		float3(3.806114E-05,	1.487243E-05,	0.000000E+00),
		float3(2.758222E-05,	1.080001E-05,	0.000000E+00),
		float3(2.004122E-05,	7.863920E-06,	0.000000E+00),
		float3(1.458792E-05,	5.736935E-06,	0.000000E+00),
		float3(1.068141E-05,	4.211597E-06,	0.000000E+00),
		float3(7.857521E-06,	3.106561E-06,	0.000000E+00),
		float3(5.768284E-06,	2.286786E-06,	0.000000E+00),
		float3(4.259166E-06,	1.693147E-06,	0.000000E+00),
		float3(3.167765E-06,	1.262556E-06,	0.000000E+00),
		float3(2.358723E-06,	9.422514E-07,	0.000000E+00),
		float3(1.762465E-06,	7.053860E-07,	0.000000E+00)
	};

	float3 table2[89] = {
		float3(0.003769647000000E6, 0.000414616100000E6, 0.018472600000000E6),
		float3(0.009382967000000E6, 0.001059646000000E6, 0.046097840000000E6),
		float3(0.022143020000000E6, 0.002452194000000E6, 0.109609000000000E6),
		float3(0.047429860000000E6, 0.004971717000000E6, 0.236924600000000E6),
		float3(0.089538030000000E6, 0.009079860000000E6, 0.450836900000000E6),
		float3(0.144621400000000E6, 0.014293770000000E6, 0.737882200000000E6),
		float3(0.203572900000000E6, 0.020273690000000E6, 1.051821000000000E6),
		float3(0.248852300000000E6, 0.026121060000000E6, 1.305008000000000E6),
		float3(0.291824600000000E6, 0.033190380000000E6, 1.552826000000000E6),
		float3(0.322708700000000E6, 0.041579400000000E6, 1.748280000000000E6),
		float3(0.348255400000000E6, 0.050336570000000E6, 1.917479000000000E6),
		float3(0.341848300000000E6, 0.057433930000000E6, 1.918437000000000E6),
		float3(0.322463700000000E6, 0.064723520000000E6, 1.848545000000000E6),
		float3(0.282664600000000E6, 0.072383390000000E6, 1.664439000000000E6),
		float3(0.248525400000000E6, 0.085148160000000E6, 1.522157000000000E6),
		float3(0.221978100000000E6, 0.106014500000000E6, 1.428440000000000E6),
		float3(0.180690500000000E6, 0.129895700000000E6, 1.250610000000000E6),
		float3(0.129192000000000E6, 0.153506600000000E6, 0.999178900000000E6),
		float3(0.081828950000000E6, 0.178804800000000E6, 0.755237900000000E6),
		float3(0.046008650000000E6, 0.206482800000000E6, 0.561731300000000E6),
		float3(0.020839810000000E6, 0.237916000000000E6, 0.409931300000000E6),
		float3(0.007097731000000E6, 0.285068000000000E6, 0.310593900000000E6),
		float3(0.002461588000000E6, 0.348353600000000E6, 0.237675300000000E6),
		float3(0.003649178000000E6, 0.427759500000000E6, 0.172001800000000E6),
		float3(0.015569890000000E6, 0.520497200000000E6, 0.117679600000000E6),
		float3(0.043151710000000E6, 0.620625600000000E6, 0.082835480000000E6),
		float3(0.079629170000000E6, 0.718089000000000E6, 0.056504070000000E6),
		float3(0.126846800000000E6, 0.794644800000000E6, 0.037519120000000E6),
		float3(0.181802600000000E6, 0.857579900000000E6, 0.024381640000000E6),
		float3(0.240501500000000E6, 0.907134700000000E6, 0.015661740000000E6),
		float3(0.309811700000000E6, 0.954467500000000E6, 0.009846470000000E6),
		float3(0.380424400000000E6, 0.981410600000000E6, 0.006131421000000E6),
		float3(0.449420600000000E6, 0.989022800000000E6, 0.003790291000000E6),
		float3(0.528023300000000E6, 0.999460800000000E6, 0.002327186000000E6),
		float3(0.613378400000000E6, 0.996773700000000E6, 0.001432128000000E6),
		float3(0.701677400000000E6, 0.990254900000000E6, 0.000882253100000E6),
		float3(0.796775000000000E6, 0.973261100000000E6, 0.000545241600000E6),
		float3(0.885337600000000E6, 0.942456900000000E6, 0.000338673900000E6),
		float3(0.963838800000000E6, 0.896361300000000E6, 0.000211777200000E6),
		float3(1.051011000000000E6, 0.858720300000000E6, 0.000133503100000E6),
		float3(1.109767000000000E6, 0.811586800000000E6, 0.000084944680000E6),
		float3(1.143620000000000E6, 0.754478500000000E6, 0.000054607060000E6),
		float3(1.151033000000000E6, 0.691855300000000E6, 0.000035496610000E6),
		float3(1.134757000000000E6, 0.627006600000000E6, 0.000023347380000E6),
		float3(1.083928000000000E6, 0.558374600000000E6, 0.000015546310000E6),
		float3(1.007344000000000E6, 0.489595000000000E6, 0.000010483870000E6),
		float3(0.914287700000000E6, 0.422989700000000E6, 0E6),
		float3(0.813556500000000E6, 0.360924500000000E6, 0E6),
		float3(0.692471700000000E6, 0.298086500000000E6, 0E6),
		float3(0.575541000000000E6, 0.241690200000000E6, 0E6),
		float3(0.473122400000000E6, 0.194312400000000E6, 0E6),
		float3(0.384498600000000E6, 0.154739700000000E6, 0E6),
		float3(0.299737400000000E6, 0.119312000000000E6, 0E6),
		float3(0.227779200000000E6, 0.089795940000000E6, 0E6),
		float3(0.170791400000000E6, 0.066710450000000E6, 0E6),
		float3(0.126380800000000E6, 0.048996990000000E6, 0E6),
		float3(0.092245970000000E6, 0.035599820000000E6, 0E6),
		float3(0.066399600000000E6, 0.025542230000000E6, 0E6),
		float3(0.047106060000000E6, 0.018079390000000E6, 0E6),
		float3(0.032921380000000E6, 0.012615730000000E6, 0E6),
		float3(0.022623060000000E6, 0.008661284000000E6, 0E6),
		float3(0.015754170000000E6, 0.006027677000000E6, 0E6),
		float3(0.010967780000000E6, 0.004195941000000E6, 0E6),
		float3(0.007608750000000E6, 0.002910864000000E6, 0E6),
		float3(0.005214608000000E6, 0.001995557000000E6, 0E6),
		float3(0.003569452000000E6, 0.001367022000000E6, 0E6),
		float3(0.002464821000000E6, 0.000944726900000E6, 0E6),
		float3(0.001703876000000E6, 0.000653705000000E6, 0E6),
		float3(0.001186238000000E6, 0.000455597000000E6, 0E6),
		float3(0.000826953500000E6, 0.000317973800000E6, 0E6),
		float3(0.000575830300000E6, 0.000221744500000E6, 0E6),
		float3(0.000405830300000E6, 0.000156556600000E6, 0E6),
		float3(0.000285657700000E6, 0.000110392800000E6, 0E6),
		float3(0.000202185300000E6, 0.000078274420000E6, 0E6),
		float3(0.000143827000000E6, 0.000055788620000E6, 0E6),
		float3(0.000102468500000E6, 0.000039818840000E6, 0E6),
		float3(0.000073475510000E6, 0.000028601750000E6, 0E6),
		float3(0.000052598700000E6, 0.000020512590000E6, 0E6),
		float3(0.000038061140000E6, 0.000014872430000E6, 0E6),
		float3(0.000027582220000E6, 0.000010800010000E6, 0E6),
		float3(0.000020041220000E6, 0.000007863920000E6, 0E6),
		float3(0.000014587920000E6, 0.000005736935000E6, 0E6),
		float3(0.000010681410000E6, 0.000004211597000E6, 0E6),
		float3(0.000007857521000E6, 0.000003106561000E6, 0E6),
		float3(0.000005768284000E6, 0.000002286786000E6, 0E6),
		float3(0.000004259166000E6, 0.000001693147000E6, 0E6),
		float3(0.000003167765000E6, 0.000001262556000E6, 0E6),
		float3(0.000002358723000E6, 0.000000942251400E6, 0E6),
		float3(0.000001762465000E6, 0.000000705386000E6, 0E6)
	};

	// TODO: convert to RGB
	float3x3 xyz2srgb = {  
		 3.2404542, -1.5371385, -0.4985314,
        -0.9692660,  1.8760108,  0.0415560,
         0.0556434, -0.2040259,  1.0572252  
    };

    float3x3 xyz2rgb = {  
		 0.41847, -0.15866, -0.082835,
		 -0.091169, 0.25243, 0.015708,
		 0.00092090, -0.0025498, 0.17860 
    };

    float3 XYZ = float3(0, 0, 0);
    [unroll]
    for (uint i = 0u; i < 89u; ++i) {
    	float w = (390.0 + 5.0*float(i-1));
    	XYZ += (3.7402 * table2[i])/(pow(w, 5.0) * 1E-14 * (exp(14384800.0/(w*T)) - 1.0));
    	//XYZ += 3.7402/(pow(w, 5.0) * 1E-20 * (exp(1.43848/(w*0.0000001*T)) - 1.0)) * table[i];
    }
    XYZ *= 5.0; // integrate with step size

    float3 result = mul(xyz2srgb, XYZ);

    #if defined(HAS_BLEND_FACTOR)
    	//result = lerp(result, normalize(result), blend);
    	//TODO: convert to xyZ space and lerp http://magnuswrenninge.com/content/pubs/ProductionVolumeRenderingSystems2011.pdf
    #endif

	RESULT(result);
"""
